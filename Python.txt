import tkinter as tk
from tkinter import messagebox
import serial
import time

# ---------- Variáveis Globais ----------
arduino = None
modo_selecionado = None
cooldown = None
COOLDOWN_TIME = 60  # segundos

# ---------- Funções ----------
def verificar_conexao_arduino():
    global arduino
    try:
        arduino = serial.Serial('COM3', 9600, timeout=1)
        time.sleep(2)  # espera Arduino resetar
        messagebox.showinfo("Conexão", "Dispositivo Conectado")
    except serial.SerialException:
        messagebox.showerror("Erro", "Nenhum dispositivo conectado")

def enviar_para_arduino(valor):
    if arduino is None or not arduino.is_open:
        return "Erro: Nenhuma conexão com o Arduino."
    try:
        arduino.write((valor + "\n").encode())
        resposta = arduino.readline().decode().strip()
        return resposta if resposta else "Sem resposta do Arduino"
    except Exception as e:
        return f"Erro: {e}"

def trocar_modo(nm):
    global cooldown, modo_selecionado

    agora = time.time()
    if cooldown is not None:
        tempo_restante = COOLDOWN_TIME - int(agora - cooldown)
        if tempo_restante > 0:
            messagebox.showwarning(
                "Cooldown",
                f"Tente novamente em {tempo_restante} segundos."
            )
            return

    modo_selecionado.set(nm)
    cooldown = agora
    resposta = enviar_para_arduino(nm)
    lbl_status.config(text=f"Modo: {nm} | Arduino: {resposta}")

def checar_atividade():
    if modo_selecionado.get() == "":
        messagebox.showwarning("Modo", "Selecione um modo")
        return
    resposta = enviar_para_arduino(modo_selecionado.get())
    lbl_status.config(text=f"Arduino: {resposta}")

# ---------- Interface ----------
janela = tk.Tk()
janela.title("Controle Arduino")
janela.geometry("400x300")

modo_selecionado = tk.StringVar(value="")  # valor inicial vazio

# Radiobuttons
tk.Radiobutton(janela, text="Açai", variable=modo_selecionado, value="Açai",
               command=lambda: trocar_modo("Açai")).pack(pady=5)
tk.Radiobutton(janela, text="Sorvete", variable=modo_selecionado, value="Sorvete",
               command=lambda: trocar_modo("Sorvete")).pack(pady=5)
tk.Radiobutton(janela, text="Bebidas", variable=modo_selecionado, value="Bebidas",
               command=lambda: trocar_modo("Bebidas")).pack(pady=5)

# Botões
tk.Button(janela, text="Submit", width=25, command=checar_atividade).pack(pady=10)
tk.Button(janela, text="Verificar Conexão", width=25, command=verificar_conexao_arduino).pack(pady=10)

# Label de status
lbl_status = tk.Label(janela, text="Status: Nenhum modo selecionado")
lbl_status.pack(pady=20)

janela.mainloop()
